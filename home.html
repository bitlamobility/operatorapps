<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="style.css">
        <title>Operator Lists</title> 
    </head>
    <body>
        <div id="loader" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="navbar-brand d-flex align-items-center" href="home.html">
                    <i class="fas fa-mobile-alt mr-2"></i>
                    Operator Apps
                </a>
        
                <!-- Hamburger Menu -->
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
        
                <!-- Navigation Items -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active" id="menu_home">
                            <a class="nav-link" href="home.html">
                                <i class="fas fa-home mr-1"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item" id="menu_dashboard">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-chart-line mr-1"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item" id="menu_create_new_operator">
                            <a class="nav-link" href="createoperator.html">
                                <i class="fas fa-plus-circle mr-1"></i>
                                <span>Create Operator</span>
                            </a>
                        </li>
                        <!-- <li class="nav-item" id="menu_download_script">
                            <a class="nav-link" href="downloadScript.html">
                                <i class="fas fa-download mr-1"></i>
                                <span>Download</span>
                            </a>
                        </li> -->
                        <li class="nav-item" id="menu_fileviewer">
                            <a class="nav-link" href="githubfileviewer.html">
                                <i class="fas fa-folder-open mr-1"></i>
                                <span>Subdomains</span>
                            </a>
                        </li>
                        <li class="nav-item" id="menu_inactive">
                            <a class="nav-link" href="inactive.html">
                                <i class="fas fa-pause-circle mr-1"></i>
                                <span>Inactive</span>
                            </a>
                        </li>
                        <li class="nav-item" id="menu_logout">
                            <a class="nav-link" href="javascript:void(0);" id="logout">
                                <i class="fas fa-sign-out-alt mr-1"></i>
                                <span>Logout</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container-fluid">
            <div class="card mt-3 ml-5 mr-5">
                <!-- Card Header with Collapse Toggle -->
                <div class="card-header bg-light">
                    <button class="btn btn-link btn-block text-left p-0 d-flex justify-content-between align-items-center" 
                            data-toggle="collapse" 
                            data-target="#controlsCollapse" 
                            aria-expanded="true" 
                            aria-controls="controlsCollapse">
                        <span class="font-weight-bold">Search / Controls / Filters</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            
                <!-- Collapsible Content -->
                <div id="controlsCollapse" class="collapse show">
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-lg-6 col-md-12 col-sm-12 mb-2">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <select class="form-control" id="country">
                                                <option value="">Account Filter</option>
                                                <option value="national">Own Account</option>
                                                <option value="africa">Bitla Account</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mt-2">
                                        <div class="form-group mb-0">
                                            <input type="text" id="customSearch" class="form-control" placeholder="Search any keywords...">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="row">
                                    <div class="col-sm-3 mb-2">
                                        <button id="submitButton" class="btn btn-primary btn-block btn-lg" style="height: 100px; font-size: 15px;">
                                            <i class="fas fa-cogs mr-1"></i></br>
                                            Generate Build
                                        </button>
                                    </div>
                                    <div class="col-sm-3  mb-2">
                                        <button id="resetBuildButton" class="btn btn-danger btn-block btn-lg" style="height: 100px; font-size: 15px;">
                                            <i class="fas fa-rotate-left mr-1"></i></br>
                                            Reset </br>Build
                                        </button>
                                    </div>
                                    <div class="col-sm-3 mb-2">
                                        <button id="movetoinvalid" class="btn btn-info btn-block btn-lg" style="height: 100px; font-size: 15px;">
                                            <i class="fas fa-rotate-left mr-1"></i></br>
                                            Move to Invalid
                                        </button>
                                    </div>
                                    <div class="col-sm-3">
                                        <button id="downloadExcel" class="btn btn-success btn-block btn-lg" style="height: 100px; font-size: 15px;">
                                            <i class="fas fa-file-excel mr-1"></i></br>
                                            Download Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mt-2 ml-5 mr-5 mb-5">
                <div class="card-header">
                    <span class="h5">Bitla Software App Lists</span>
                    <!-- <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                            <button type="button" id="downloadExcel" class="btn btn-success"><i class="fas fa-file-excel mr-1"></i>Download Excel</button>
                          
                            <div class="btn-group" role="group">
                              <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                Options
                              </button>
                              <div class="dropdown-menu">
                                <a id="submitButton" class="dropdown-item text-primary" href="javascript:void(0);"><i class="fas fa-cogs mr-2"></i>Generate Build</a>
                                <a id="resetBuildButton" class="dropdown-item text-danger" href="javascript:void(0);"><i class="fas fa-rotate-left mr-2"></i>Reset Build</a>
                                <a id="movetoinvalid" class="dropdown-item text-info" href="javascript:void(0);"><i class="fa-solid fa-trash mr-2"></i> Move to Invalid</a>
                              </div>
                            </div>
                        </div> -->
                    <!-- <div class="d-flex align-items-center">
                        <div class="input-group mr-2" style="width:200px;">
                            <select class="form-control" id="country">
                                <option value="">Select Account</option>
                                <option value="national">Own Account</option>
                                <option value="africa">Bitla Account</option>
                            </select>
                        </div>
                        <div class="input-group mr-2" style="width: 200px;">
                            <input type="text" id="customSearch" class="form-control" placeholder="Search any keywords...">
                        </div>
                        <button id="submitButton" class="btn btn-primary d-flex align-items-center mr-2" style="height: 38px;display: none !important;">
                            <i class="fas fa-cogs mr-1"></i>
                            Generate Build
                        </button>
                        <button id="resetBuildButton" class="btn btn-danger d-flex align-items-center mr-2" style="height: 38px;display: none !important;">
                            <i class="fas fa-rotate-left mr-1"></i>
                            Reset Build
                        </button>
                        <button id="movetoinvalid" class="btn btn-info d-flex align-items-center mr-2" style="height: 38px;display: none !important;">
                            <i class="fas fa-rotate-left mr-1"></i>
                            Move to Invalid
                        </button>
                        <button id="downloadExcel" class="btn btn-success d-flex align-items-center" style="height: 38px;display: none !important;">
                            <i class="fas fa-file-excel mr-1"></i>
                            Download Excel
                        </button>
                    </div> -->
                </div>
                <div class="card-body">
                    <div class="table-wrapper">
                        <table class="table table-bordered" id="example">
                            <thead class="bg-success">
                                <tr>
                                    <th>Select</th>
                                    <th>Action</th>
                                    <th>Build Required</th>
                                    <th>Version</th>
                                    <th>Version Code</th>
                                    <th>Sub Domain</th>
                                    <th>Key File Name</th>
                                    <th>Alias Name</th>
                                    <th>Password</th>
                                    <th>Android Package Name</th>
                                    <th>Operator Name</th>
                                    <th>Base URL</th>
                                    <th>Country Name</th>
                                    <th>Developer Name</th>
                                    <th>Last App Published Date</th>
                                    <th>Play Store Link</th>
                                    <th>Region</th>
                                    <th>Analytics Email</th>
                                    <th>Analytics Property</th>
                                    <th>Travel Code</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="responseModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Build Number</h5>
                        <button type="button" class="close" id="responseModalClose">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body text-center">
                        <h5 id="responseMessage"></h5>
                        <p>Note: Kindly use the above build number for build generation</p>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
        
        <script>
            $(document).ready(function() {
                // Add smooth scrolling when mobile menu is opened
                $('.navbar-toggler').click(function() {
                    $('body').toggleClass('nav-open');
                });
            
                // Close mobile menu when link is clicked
                $('.nav-link').click(function() {
                    $('.navbar-collapse').collapse('hide');
                });
            
                // Add active class to current page
                const currentPage = window.location.pathname.split('/').pop();
                $('.nav-link').each(function() {
                    if ($(this).attr('href') === currentPage) {
                        $(this).parent().addClass('active').siblings().removeClass('active');
                    }
                });
            });
        </script>
        <script>
            $(document).ready(function () {
                // const API_URL = "https://script.google.com/macros/s/AKfycbyN92CNP9xwCIBkFSonIuYQpGQMRATgpWtax3U1Qs2vWUiR7rPAagPNgpvCebsn2_gZ/exec"; // my email
                const API_URL = "https://script.google.com/macros/s/AKfycbxYfyiL-Ns_VK1t0K37dnt5ryTLM9a5fH4FlKdOnBo3rbCNpFu9iIifuRqVWXy_mIAhGQ/exec"; // official email

                storedEmpId = sessionStorage.getItem("empid");
                sessionemptoken = sessionStorage.getItem("emptoken");
                sessionemprole = sessionStorage.getItem("emprole");

                // alert(storedEmpId);
                // alert(sessionemptoken);

                function handleRoleVisibility() {
                    if(sessionemprole == "appdeveloper") {
                        $("#menu_dashboard").hide();
                        $("#menu_download_script").hide();
                        $("#submitButton").show();
                        $("#movetoinvalid").hide();
                    } else if(sessionemprole == "support") {
                        $("#menu_download_script").hide();
                        $("#menu_create_new_operator").hide();
                        $("#downloadExcel").show();
                        $("#menu_dashboard").hide();
                        $("#menu_pushfile").hide();
                        $("#movetoinvalid").hide();
                        $("#menu_fileviewer").hide();
                    } else if(sessionemprole == "admin") {
                        $("#resetBuildButton").show();
                        $("#movetoinvalid").show();
                        $("#submitButton").show();
                        $("#downloadExcel").show();
                    } else if(sessionemprole == "maintainer") {
                        $("#resetBuildButton").show();
                        $("#movetoinvalid").show();
                        $("#submitButton").show();
                        $("#downloadExcel").show();
                        $("#menu_download_script").hide();
                        $("#menu_dashboard").hide();
                    } else {
                        $("#movetoinvalid").hide();
                        $("#menu_dashboard").hide();
                        $("#menu_download_script").hide();
                        $("#menu_fileviewer").hide();
                    }
                }

                // Call the function after document is ready
                handleRoleVisibility();


                
                if (!storedEmpId || !sessionemptoken) {
                    window.location.href = "index.html";
                }else{
                    loadDataTable(storedEmpId,sessionemptoken,sessionemprole);
                }

                $("#logout").click(function(){
                    sessionStorage.clear();
                    window.location.href = "index.html";
                });
                

                function loadDataTable(empid, sessionemptoken,sessionemprole) {
                    $('#loader').removeClass("d-none");
                    
                    $('.count-section, .countdata').show();
                    let selectedSubdomains = new Set();

                    const table = $('#example').DataTable({
                        ajax: {
                            url: `${API_URL}?authtoken=${sessionemptoken}&fetch_entry=true&empid=${empid}`,
                            //dataSrc: 'app_lists',
                            dataSrc: function (response) {
                                // Check the response code
                                if (response.code === 200) {
                                    // If the code is 200, return the data to be used by DataTable
                                    return response.app_lists;
                                } else {
                                    // If the code is not 200 (invalid access token), redirect to login page
                                    sessionStorage.clear();
                                    window.location.href = "index.html";  // Change this URL as per your app's login route
                                    return []; // Return an empty array to prevent DataTable from rendering
                                }
                            }
                        },
                        columns: [
                            {
                                data: 'sub_domain',
                                render: function (data) {
                                    return `<input type="checkbox" name="${data}" class="rowCheckbox" data-subdomain="${data}">`;
                                }
                            },
                            {
                                data: 'sub_domain',
                                render: function (data, type, row) {
                                    // Check if the render type is 'display' for DataTables
                                    if (type === 'display') {
                                        const base64Encoded = btoa(storedEmpId+":"+data.trim()+":"+sessionemptoken);
                                        return `<input type="button" class="btn btn-primary editBtn" value="Edit" data-subdomain="${base64Encoded}">`;
                                    }
                                    return data; // Return raw data for export or other processing
                                }
                            },
                            { data: 'build_required' },
                            { data: 'version' },
                            { data: 'version_code' },
                            { data: 'sub_domain' },
                            { data: 'key_file_name' },
                            { data: 'alias_name' },
                            { data: 'password' },
                            { data: 'android_package_name' },
                            { data: 'operator_name' },
                            { data: 'base_url' },
                            { data: 'country_name' },
                            { data: 'developer_name' },
                            {
                                data: 'last_app_published_date',
                                render: function (data) {
                                    return data ? new Date(data).toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' }) : "N/A";
                                }
                            },
                            {
                                data: 'playstore_link',
                                render: function (data) {
                                    // Check if the playstore_link exists and is a valid URL
                                    return data ? `<a href="${data}" target="_blank">${data}</a>` : 'N/A';
                                }
                            },
                            { data: 'region' },
                            { data: 'analytics_email' },
                            { data: 'analytics_property' },
                            { data: 'travel_code' }
                        ],
                        processing: true,
                        responsive: true,
                        scrollX: true,
                        searching: true,
                        pageLength: 10,
                        paging: true,
                        fixedHeader: {
                            header: true,
                            headerOffset: 55  // Adjust this value based on your navbar height
                        },
                        scrollX: true,
                        scrollY: '60vh',     // Adjust the height as needed
                        scrollCollapse: true,
                        'columnDefs': [ {
                            'targets': [0,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19], /* column index */
                            'orderable': false, /* true or false */
                        }],
                        lengthMenu: [5, 10, 25, 50, 100],
                        initComplete: function () {
                            
                            if (sessionemprole === 'support') {
                                table.column(0).visible(false);  // Column index starts at 0
                                table.column(1).visible(false);  // Column index starts at 0
                                table.column(2).visible(false);  // Column index starts at 0
                                table.column(3).visible(false);  // Column index starts at 0
                                table.column(4).visible(false);  // Column index starts at 0
                                // table.column(5).visible(false);  // Column index starts at 0
                                table.column(6).visible(false);  // Column index starts at 0
                                table.column(7).visible(false);  // Column index starts at 0
                                table.column(8).visible(false);  // Column index starts at 0
                                table.column(16).visible(false);  // Column index starts at 0
                                table.column(17).visible(false);  // Column index starts at 0
                                table.column(18).visible(false);  // Column index starts at 0
                            }
                        },
                        
                    });

                    // Handle checkbox selection
                    $('#example tbody').on('change', '.rowCheckbox', function () {
                        const subdomain = $(this).data('subdomain');
                        if (this.checked) {
                            selectedSubdomains.add(subdomain);
                        } else {
                            selectedSubdomains.delete(subdomain);
                        }
                    });

                    // Add this inside your loadDataTable function after the submit button click handler

                    $('#movetoinvalid').on('click', function () {
                        if (selectedSubdomains.size === 0) {
                            alert("Please select at least one subdomain.");
                            return;
                        }

                        $('#loader').removeClass("d-none");

                        // Get selected rows data
                        const selectedRows = table.rows().data().filter(function(rowData) {
                            return selectedSubdomains.has(rowData.sub_domain);
                        });

                        let processedCount = 0;
                        let errors = [];

                        // Process each selected row
                        selectedRows.each(function(rowData) {
                            const buildRequired = rowData.build_required;
                            const subdomain = rowData.sub_domain;

                            $.ajax({
                                url: `${API_URL}?subdomain=${subdomain}&markAsInactive=true&authtoken=${sessionemptoken}&empid=${empid}`,
                                type: 'GET',
                                success: function(response) {
                                    processedCount++;
                                    checkCompletion();
                                },
                                error: function(xhr, status, error) {
                                    processedCount++;
                                    errors.push(`Failed to reset build for ${subdomain}: ${error}`);
                                    checkCompletion();
                                }
                            });
                        });

                        function checkCompletion() {
                            if (processedCount === selectedRows.length) {
                                $('#loader').addClass("d-none");
                                
                                if (errors.length > 0) {
                                    // Show errors if any
                                    $('#responseMessage').html(`Completed with ${errors.length} errors:<br>${errors.join('<br>')}`);
                                } else {
                                    // Show success message
                                    $('#responseMessage').text('Moved app to invalid');
                                }
                                
                                $('#responseModal').modal('show');
                                
                                // Reload table data after successful reset
                                table.ajax.reload();
                            }
                        }
                    });


                    $('#resetBuildButton').on('click', function () {
                        if (selectedSubdomains.size === 0) {
                            alert("Please select at least one subdomain.");
                            return;
                        }

                        $('#loader').removeClass("d-none");

                        // Get selected rows data
                        const selectedRows = table.rows().data().filter(function(rowData) {
                            return selectedSubdomains.has(rowData.sub_domain);
                        });

                        let processedCount = 0;
                        let errors = [];

                        // Process each selected row
                        selectedRows.each(function(rowData) {
                            const buildRequired = rowData.build_required;
                            const subdomain = rowData.sub_domain;

                            $.ajax({
                                url: `${API_URL}?build_number=${buildRequired}&subdomain=${subdomain}&is_from_script=true&update_entry=true`,
                                type: 'GET',
                                success: function(response) {
                                    processedCount++;
                                    checkCompletion();
                                },
                                error: function(xhr, status, error) {
                                    processedCount++;
                                    errors.push(`Failed to reset build for ${subdomain}: ${error}`);
                                    checkCompletion();
                                }
                            });
                        });

                        function checkCompletion() {
                            if (processedCount === selectedRows.length) {
                                $('#loader').addClass("d-none");
                                
                                if (errors.length > 0) {
                                    // Show errors if any
                                    $('#responseMessage').html(`Completed with ${errors.length} errors:<br>${errors.join('<br>')}`);
                                } else {
                                    // Show success message
                                    $('#responseMessage').text('Successfully reset build numbers for all selected operators');
                                }
                                
                                $('#responseModal').modal('show');
                                
                                // Reload table data after successful reset
                                table.ajax.reload();
                            }
                        }
                    });

                    $('#downloadExcel').on('click', function() {
                        // Create a new buttons instance
                        const excelButton = new $.fn.dataTable.Buttons(table, {
                            buttons: [
                                {
                                    extend: 'excelHtml5',
                                    exportOptions: {
                                        columns: function(idx, data, node) {
                                            return table.column(idx).visible();
                                        }
                                    }
                                }
                            ]
                        });
                        
                        // Trigger the excel button click
                        excelButton.container().find('button').trigger('click');
                    });

                    // Handle form submission
                    $('#submitButton').on('click', function () {
                        $('#loader').removeClass("d-none");

                        if (selectedSubdomains.size === 0) {
                            alert("Please select at least one subdomain.");
                            $('#loader').addClass("d-none");
                            return;
                        }
                        $.ajax({
                        
                            url: `${API_URL}?authtoken=${sessionemptoken}&subdomains=${Array.from(selectedSubdomains).join(',')}&empid=${empid}`,  // Update this to your API endpoint
                            type: 'GET',
                            success: function (response) {
                                $('#responseMessage').text(response.build_required);
                                $('#responseModal').modal('show');
                                $('#loader').addClass("d-none");
                            },
                            error: function (xhr, status, error) {
                                $('#responseMessage').text(`Error: ${error}`);
                                $('#responseModal').modal('show');
                                $('#loader').addClass("d-none");
                            }
                        });
                        
                    });

                    $('#responseModalClose').on('click', function() {
                        // Close the modal
                        $('#responseModal').modal('hide');
                        window.location.reload();
                        
                    });

                    $('#example').on('click', '.editBtn', function () {
                        const encodedSubdomain = $(this).attr("data-subdomain");
                        window.location.href = `updateoperator.html?subdomain=${encodedSubdomain}`;
                        // alert(encodedSubdomain);
                    });

                    $('#customSearch').on('keyup', function() {
                        var searchValue = this.value;
                        console.log('Search value: ', searchValue);
                        table.search(searchValue).draw();
                    });
                    // Maintain checkbox states when changing pages
                    table.on('draw', function () {
                        $(".table-wrapper").show();
                        if(sessionemprole=="support"){
                            $('#submitButton').hide();
                        }else{
                            $('#submitButton').show();
                        }
                        $('#example tbody .rowCheckbox').each(function () {
                            const subdomain = $(this).data('subdomain');
                            $(this).prop('checked', selectedSubdomains.has(subdomain));
                        });
                    });
                    
                    // Calculate chart data based on table data
                    table.on('xhr', function () {
                        $('#loader').addClass("d-none");
                    });
                }
            });

        </script>
    </body>
</html>